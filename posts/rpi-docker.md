---
title: 嵌入式比服务器更需要 Docker
date: '2015-11-17'
description:
categories:
- Code
tags:
- Docker
---

最近 Docker 用的比较多，结合之前搞嵌入式的经验，有点新的体会。

嵌入式开发的各种问题在服务器端开发中不会发生，服务器端的各种发行版已经很成熟了，内核版本也比较统一。AWS，GAE，阿里云对 Linux 的支持都是很标准的，版本任选，部署起来非常方便。也不需要交叉编译，如果是 nodejs/py 都不需要编译。

嵌入式的话，每个厂商提供的文件系统和内核都不一样，内核你也不敢随便换。想换是吧？可以啊，那自己移植驱动去吧。内核往往还是比较低的版本，很多厂商的驱动至今都没有加入到 mainline 里（其中最恶劣的就是 TI，完全是业界毒瘤），也难怪 Linus 发飙，都是厂商的各种问题造成的。

除了内核之外文件系统也是略麻烦的，和服务器端铺张浪费的玩法相反，嵌入式端内存和闪存都是比较小的，目前 CPU 跑 gcc 的速度不能编译大型项目（以后应该可以）。
我们的做法是用 buildroot 交叉编译做好了文件系统，再把动态库手动的拷贝过去，因为需要节省空间。
整个文件系统是用 git 维护的。

所以有一些小修小补的时候，比如改了 rcS 或者是换了 wifi 的固件或者是 gpio 有小的调整，都需要重启，生成文件系统镜像，重新烧录进去，再测试。
和服务端开发不一样，嵌入式端重启要频繁的多，因为开发过程中硬件也是在频繁改动的。
这个过程比较浪费时间，而且多次烧录对 Nand 也不好。
用 nfs 可以解决问题，但在 wifi 调通之前是没有办法的，使用原厂工具刷机是最原始的办法。

我的思路是做一个这样一个东西：

模仿 Docker，把嵌入式文件系统做成一个 Docker 格式的 image。
在开发模式下，kernel 启动之后通过 USB/Uart 加载这个 image，主分区只有一个，就是 image 里的文件系统。
volume 可以是：host 上的某个目录，nand 或者 sd 卡里的可用空间。

USB/Uart 一般是芯片自带的，比 wifi 先调通（wifi 一般是另一个芯片）。

在主分区更改之后，也可以像 docker 一样提交 commit。
kernel 里只保留最核心的模块：USB/Uart 还有和 host 通信需要的东西。
如果能在 uboot 里用 usb 加载 kernel 最好。
主要是为了启动速度，最好五秒之内完成启动，便于重启频繁的开发。

在生产环境下就把 image 烧到 nand 里。image 是标准组件，不涉及底层硬件的细节，binary 一律为 armv7 格式（这个可能有点难做到，arm 还处于 32->64 更迭期间），但将来这个一定是趋势。

image 的配置文件包括什么？

- 主分区的大小，是否为 initrd
- Volume 的挂载位置和大小，Volume 的初始内容
- 程序启动的 ENTRYPOINT

有哪些 Docker 的特性可以借鉴？

- 可以使用 hub.docker.com 保存 image
- 至于说 mount/ipc/network namespace，它们作用是能让多个人共享同一个硬件进行开发，用处是有，但开发难度应该极大，另外硬件往往是进程独占的

是否能支持热更新，增量刷机？

- 应该可以

可能存在的问题：

- 不是每个嵌入式厂商都能提供 4.0+ kernel 的源码
- kernel 通过通过 USB 访问 host 的 aufs，这个工作量估计很大

